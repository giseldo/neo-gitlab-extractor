[{"id":91500846,"iid":7453,"project_id":28644964,"title":"C calling convention broken when passing structures larger than two integers.","description":"\n\u003ch3\u003e\u003cdetails\u003e\u003csummary\u003eOriginal Reporter info from Mantis: \u003csmall\u003eFlawless\u003c/small\u003e\u003c/summary\u003e\u003csmall\u003e\n\n- **Reporter name:** Christian Iversen\n\u003c/small\u003e\u003c/details\u003e\u003c/h3\u003e\n\n## Description:\n\nIf a structure is passed by value rather than reference, and is larger than 2 integers, and the calling convention is cdecl, the call will fail.\n\nOn page 13 and 16 in this pdf file:\n\nhttp://www.agner.org/optimize/calling_conventions.pdf\n\nit's quite clearly shown that objects larger than two registers should always be passed on the stack for cdecl (at least on linux, I think the rules are different for windows).\n\nfpc currently tries to pass all 5 arguments in the example program in registers, which causes it to fail. \n\n## Steps to reproduce:\n\ncompile gcc program with: gcc -masm=intel -fverbose-asm -save-temps -c test.c\u003cbr/\u003e\ncompile fpc program with: fpc -al testp.pas\n\ntestp.pas:\n``` pascal\nprogram testp;\n\nuses\n  ctypes, vorbis;\n\n{$LINKLIB 'c'}\n{$LINK 'test'}\n\nfunction ov_open_callbacks_foo(datasource: pointer; var vf: OggVorbis_File; initial: pointer; ibytes: clong; callbacks: ov_callbacks): cint; cdecl; external;\n\nvar\n  vf: OggVorbis_File;\n  cb: ov_callbacks;\nbegin\n  cb.read := read_func(pointer(10));\n  cb.seek := seek_func(pointer(20));\n  cb.close := close_func(pointer(30));\n  cb.tell := tell_func(pointer(40));\n  ov_open_callbacks_foo(pointer(1), vf, pointer(3), 4, cb);\nend.\n```\n\n\n\\#include \u0026LtPos;stdio.h\u003e\u003cbr/\u003e\n\\#include \u0026LtPos;vorbis/vorbisfile.h\u003e\n\nint ov_open_callbacks_foo(void *datasource, OggVorbis_File *vf, char *initial, long ibytes, ov_callbacks callbacks) {\u003cbr/\u003e\n```  printf(\"%p:%p:%p:%d:%p\\n\", datasource, vf, initial, ibytes, callbacks);```\u003cbr/\u003e\n}\n\n## Mantis conversion info:\n\n- **Mantis ID:** 7453\n- **OS:** Linux\n- **OS Build:** 2.6.15\n- **Build:** [2006/09/21] for x86_64\n- **Platform:** Amd64\n- **Version:** 2.2.0\n- **Fixed in version:** 2.2.0\n- **Fixed in revision:** 4688 (#360cbe1de1d45d93d439b067ed9e7f9f43515194)","state":"closed","created_at":"2006-09-23T00:12:37.000Z","updated_at":"2021-08-05T12:57:26.032Z","closed_at":"2021-08-05T12:57:25.921Z","closed_by":{"id":9245831,"username":"fpc_admin","name":"FPC Admin account","state":"active","avatar_url":"https://gitlab.com/uploads/-/system/user/avatar/9245831/avatar.png","web_url":"https://gitlab.com/fpc_admin"},"labels":["Category::Compiler","Severity::Block","Version::2.2.0"],"milestone":{"id":2175108,"iid":31,"project_id":28644964,"title":"Version 2.2.0","description":"Release version: 2.2.0","state":"closed","created_at":"2021-08-05T05:46:47.261Z","updated_at":"2021-08-05T05:46:47.558Z","due_date":"2007-05-20","start_date":null,"expired":true,"web_url":"https://gitlab.com/freepascal.org/fpc/source/-/milestones/31"},"assignees":[{"id":9055452,"username":"FPK2","name":"FPK","state":"active","avatar_url":"https://gitlab.com/uploads/-/system/user/avatar/9055452/avatar.png","web_url":"https://gitlab.com/FPK2"}],"author":{"id":9245831,"username":"fpc_admin","name":"FPC Admin account","state":"active","avatar_url":"https://gitlab.com/uploads/-/system/user/avatar/9245831/avatar.png","web_url":"https://gitlab.com/fpc_admin"},"type":"ISSUE","assignee":{"id":9055452,"username":"FPK2","name":"FPK","state":"active","avatar_url":"https://gitlab.com/uploads/-/system/user/avatar/9055452/avatar.png","web_url":"https://gitlab.com/FPK2"},"user_notes_count":6,"merge_requests_count":0,"upvotes":0,"downvotes":0,"due_date":null,"confidential":false,"discussion_locked":true,"issue_type":"issue","web_url":"https://gitlab.com/freepascal.org/fpc/source/-/issues/7453","time_stats":{"time_estimate":0,"total_time_spent":0,"human_time_estimate":null,"human_total_time_spent":null},"task_completion_status":{"count":0,"completed_count":0},"weight":100,"blocking_issues_count":0,"has_tasks":true,"task_status":"0 of 0 checklist items completed","_links":{"self":"https://gitlab.com/api/v4/projects/28644964/issues/7453","notes":"https://gitlab.com/api/v4/projects/28644964/issues/7453/notes","award_emoji":"https://gitlab.com/api/v4/projects/28644964/issues/7453/award_emoji","project":"https://gitlab.com/api/v4/projects/28644964","closed_as_duplicate_of":null},"references":{"short":"#7453","relative":"#7453","full":"freepascal.org/fpc/source#7453"},"severity":"UNKNOWN","moved_to_id":null,"service_desk_reply_to":null,"epic_iid":null,"epic":null,"iteration":null,"health_status":null},{"id":91499912,"iid":7196,"project_id":28644964,"title":"pthread_cond_timedwait is called with wrong timespec","description":"\n\u003ch3\u003e\u003cdetails\u003e\u003csummary\u003eOriginal Reporter info from Mantis: \u003csmall\u003ecrossbuilder\u003c/small\u003e\u003c/summary\u003e\u003csmall\u003e\n\n- **Reporter name:** Burkhard Carstens\n\u003c/small\u003e\u003c/details\u003e\u003c/h3\u003e\n\n## Description:\n\nIn rtl/unix/cthreads.pp line 552 ff, timespec is created from the value of timeout. According to \"man pthread_cond_wait\" and my tests, it should be now+timeout. iow, this is meant to specify the absolute time, when the timeout should ocour rather than a relative timeout. \u003cbr/\u003e\nThe way it is now, this allwas gives a time in the past, therefore this call allways returns immediately.\n\n\n## Mantis conversion info:\n\n- **Mantis ID:** 7196\n- **OS:** linux\n- **OS Build:** suse 10.0\n- **Build:** 4277\n- **Platform:** i386\n- **Version:** 2.2.0","state":"closed","created_at":"2006-07-22T20:10:31.000Z","updated_at":"2021-08-05T12:45:49.519Z","closed_at":"2021-08-05T12:45:49.390Z","closed_by":{"id":9245831,"username":"fpc_admin","name":"FPC Admin account","state":"active","avatar_url":"https://gitlab.com/uploads/-/system/user/avatar/9245831/avatar.png","web_url":"https://gitlab.com/fpc_admin"},"labels":["Category::RTL","Version::2.2.0"],"milestone":null,"assignees":[],"author":{"id":9245831,"username":"fpc_admin","name":"FPC Admin account","state":"active","avatar_url":"https://gitlab.com/uploads/-/system/user/avatar/9245831/avatar.png","web_url":"https://gitlab.com/fpc_admin"},"type":"ISSUE","assignee":null,"user_notes_count":5,"merge_requests_count":0,"upvotes":0,"downvotes":0,"due_date":null,"confidential":false,"discussion_locked":true,"issue_type":"issue","web_url":"https://gitlab.com/freepascal.org/fpc/source/-/issues/7196","time_stats":{"time_estimate":0,"total_time_spent":0,"human_time_estimate":null,"human_total_time_spent":null},"task_completion_status":{"count":0,"completed_count":0},"weight":300,"blocking_issues_count":0,"has_tasks":true,"task_status":"0 of 0 checklist items completed","_links":{"self":"https://gitlab.com/api/v4/projects/28644964/issues/7196","notes":"https://gitlab.com/api/v4/projects/28644964/issues/7196/notes","award_emoji":"https://gitlab.com/api/v4/projects/28644964/issues/7196/award_emoji","project":"https://gitlab.com/api/v4/projects/28644964","closed_as_duplicate_of":null},"references":{"short":"#7196","relative":"#7196","full":"freepascal.org/fpc/source#7196"},"severity":"UNKNOWN","moved_to_id":null,"service_desk_reply_to":null,"epic_iid":null,"epic":null,"iteration":null,"health_status":null}]